---
title: "Laboratorio 1"
output: html_notebook
---
*CCF*

```{r}
library(MTS)
library(arfima)
library(forecast)
library(readxl)
setwd("C:/Users/fra24/OneDrive/Documenti/uni/magistrale/economici/lab1/")
```

Ripasso funzione di cross-correlazione, 
Cambiamenti percentuali di serie trismestali di divsersi indicatori economici, negli USA dal 1970 al 2019
```{r}
?stats::ccf #cross correlazione tra x(t+k) e y(t)
uschange = read.csv("fpp3_uschange.csv")
uschange = ts(uschange[,-1], start = c(1970,1), frequency = 4)
head(uschange)
```
Estraggo le varie serie storiche
```{r}
Consumption = uschange[,"Consumption"]
Income = uschange[,"Income"]
Production = uschange[,"Production"]
Savings = uschange[,"Savings"]
Unemployment = uschange[,"Unemployment"]
```

Consideriamo le cross correlazioni tra le varie serie storiche,
non guardiamo le variazioni strane,
tutte le cross corr che escono dalle bande sono significative e positive, c'è una relazione positiva tra le variabili, inoltre esiste una cross correlazione simultanea (dato dal tempo 0), e poi il reddito ha un qualche effetto sui consumi ad un tempo ritardato, avendo dei coeff significativamnte diversi da 0 a destra, lo stesso vale a sx quindi esiste una direzione di causalità bidirezionale tra le due serie
```{r}
ccf(Consumption, Income, ylab="CCF") #cross correlazione tra consumi(t+k) [x] e income(t) [y]
ccf(Income, Consumption, ylab="CCF") #reddito(t+k) consumi(t)
```
In questo caso, vediamo che i coeff significativi sono tutti negativi, quindi c'è una relazione negativa tra le due variabili, per k=0 c'è un coeff significativo -> c'è cross correlazione istantanea, le due variabili inoltre si causano a vicenda essendo coeff != 0 sign. sia a dx che a sx.
```{r}
ccf(Production, Unemployment, ylab="CCF") #produzione(t+k) disoccupazione(t)
ccf(Unemployment, Production, ylab="CCF") #disoccupazione(t) 
```
*Transfer Function Model*

Modello a funzione di trasferimento per il dataset benzina (andamento prezzo della benzina, giornaliero)
```{r}
dati = read_excel("benzina.xlsx")
str(dati)
head(dati)
```
Estraggo le serie storiche che ci interessano (costo benzina, costo petrolio)
```{r}
Benzina = ts(dati$Benzina) #non inserisco altri parametri
COP = ts(dati$COP)
```

I movimenti delle due serie sono un pò differenti, ma comunque sembrano andare assieme, infatti a livello teorico si può immagiinare come il prezzo della benzina aumenti all'aumentare del prezzo del petrolio, foprse non nello stesso istante. Le serie non sembrano stazionarie, ci sono dei cambiamenti in media.
```{r}
par(mfrow=c(2,1))
plot(Benzina)
plot(COP)
par(mfrow=c(1,1))
```
Si vede proprio dalle ACF che le serie non sono stazionarie, i coeff rimangono molto significativi e con valori molto elevati per molto tempo. Le serie sono non staz. ha senso differenziare.

Noi però non differenziamo
```{r}
par(mfrow=c(2,1))
acf(Benzina, 60) #60 periodi
acf(COP, 60)
par(mfrow=c(1,1))
```
Non avendo differenziato la CCF non mi da alcuna indicazione utile, altro segno che le serie non sono stazionarie.
Andiamo a differenziare.

Dalla ccf mi aspetto di avere corr significative solo a sx (petrolio -> benzina)
Il prezzo del petrolio di una settimana fa influisce sul prezzo della benza di adesso.
Non avendo ancora sbiancato la serie ci posso essere anomalie nelle corr a dx.
Non c'è corr simultanea (k=0),
```{r}
ccf(COP, Benzina, lag.max = 20, ylab="CCF") #prezzi petrolio(t+k) e prezzo benzina(t)
ccf(diff(COP), diff(Benzina), lag.max = 20, ylab="CCF") #prezzi petrolio(t+k) e prezzo benzina(t) diff

```
Adesso lavoriamo su COP differenziato
Vediamo che modello ARMA possiamo adattare alla serie COP per sbiancarla.

Nella ACF si può vedere una leggera autocorrelazione, al ritardo 3 -> potrebbe essere un AR(3)
```{r}
Cop_d = diff(COP)
par(mfrow=c(3,1))
plot(COP) #non diff
acf(Cop_d, 20)
pacf(Cop_d, 20)
```
Imposto il modello AR(3)
```{r}
modx = Arima(Cop_d, order = c(3,0,0)) #theta1, theta2 non sign teoricamente
modx

#pvalue? boh -> significativo se il rapporto supera 1.96/2
0.0227/0.1154
0.002/0.031
-0.0259/0.0310
0.0964/0.0311 #sign
```

Vincolo i parametri non significativi in modo da non includerli nel modello, così da avere un modello più accurato
```{r}
modx = Arima(Cop_d, order = c(3,0,0), fixed = c(0,0,NA,0)) #theta1, theta2 e intercetta a 0
modx
```
ACF e PACF campionarie? si vede la componente 8 ancora sign., pace
```{r}
acf(modx$residuals, 20)
pacf(modx$residuals, 20)
```
Ci da i residui del modello, la funzione di autocorrelazione e la statistica di Jung-Box
E si nota quello che avevamo già capito -> non possiamo accettare l'ipotesi nulla da 8 in poi
perchè alpha oss > 0.05
```{r}
tsdiag(modx,20)
```
Trovato il modello per x, mettiamo dentro alpha i residui di questo mmodello.
SE a zero tutto ok?

Dentro beta ci metto i residui del modello
```{r}
benzina_d = diff(Benzina)
alpha = modx$residuals
mod_filter = Arima(benzina_d, model = modx) #filtra con lo stesso modello la serie in input
mod_filter

beta = mod_filter$residuals
```
Adesso vediamo la CCF tra alpha e beta, per cercare di capire qual è la funzione di trasferimento, se la teoria funziona la ccf è proporzionale alla funzione di input (non ricordo il nome).

Osservando la ccf
- b = 1, il petrolio ritardato di 1 ha effetto sul prezzo della benzina di oggi, anche il prezzo di 2/3 settimane - fa influisce 
- r = 1, s = 1 uhmmm capire bene
- r = 0, s = 2 alternativa valida

posso provare quindi due modelli 
```{r}
ccf(alpha, beta) #alpha(t+k) "x" e beta(t) "y"
ccf(beta, alpha) #alpha(t) "x" e beta(t+k) "y"


tfmod1 = tfm1(benzina_d, Cop_d, orderN = c(0, 0, 0), orderX = c(0, 2, 1)) #r, s, b
```
Potrebbe non essere il modello più adeguato, potremmo quindi avere r=1
ho alcune cross corr significative vicine allo 0, non va bene

Forse aggiungendo la comp per i residui magari si sistema tutto
```{r}
ccf(alpha, tfmod1$residuals, main = "alfa & TFM", ylab = "CCF")
```
Entrambe molto velocemnte a 0, o AR corto o MA corto
Sembra AR(2), aggiungiamo all comp di errore questa specifica

Non ancora il massimo ma potrei usare ancora un modello (1,1,1), buh
```{r}
par(mfrow=c(2,1))
acf(tfmod1$residuals)
pacf(tfmod1$residuals)

tfmod1 = tfm1(benzina_d, Cop_d, orderN = c(2, 0, 0), orderX = c(0, 2, 1)) #p,d,q per "errore" & r, s, b per "x"
acf(tfmod1$residuals)
pacf(tfmod1$residuals)
par(mfrow=c(1,1))

```









